default_platform(:ios)

platform :ios do
  lane :deploy do
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: "fastlane/AuthKey_#{ENV['ASC_KEY_ID']}.p8",
      # duration: 1200,
      in_house: false
    )

    app_id  = ENV["APP_IDENTIFIER"] || "foundation.ratel.app"
    team_id = ENV["APPLE_TEAM_ID"]
    profile_name = ENV["PROFILE_NAME"] || "match AppStore #{app_id}"

    update_code_signing_settings(
      use_automatic_signing: false,
      targets: ["Runner"],
      build_configurations: ["Release"],
      team_id: team_id,
      profile_name: profile_name,
      code_sign_identity: "Apple Distribution",
      path: "Runner.xcodeproj"
    )

    build_ios_app(
      workspace:      "Runner.xcworkspace",
      scheme:         "Runner",
      configuration:  "Release",
      export_method:  "app-store",
      clean:          true,
      xcargs: "DEVELOPMENT_TEAM=#{team_id} PRODUCT_BUNDLE_IDENTIFIER=#{app_id} PROVISIONING_PROFILE_SPECIFIER='#{profile_name}' OTHER_LDFLAGS='$(inherited)' FLUTTER_BUILD_NUMBER=#{ENV['FLUTTER_BUILD_NUMBER'] || 7}",
      export_options: {
        method: "app-store",
        signingStyle: "manual",
        teamID: team_id,
        provisioningProfiles: {
          app_id => profile_name
        }
      }
    )

    upload_to_testflight(api_key: api_key, skip_waiting_for_build_processing: true)
  end
end
