# For deploy
PROJECT ?= ratel
SERVICE ?= web
VERSION ?= $(shell git rev-parse --short HEAD)
COMMIT ?= $(shell git rev-parse --short HEAD)

REPO_NAME ?= $(PROJECT)/$(SERVICE)
ECR_NAME ?= $(shell aws ecr describe-repositories --repository-names $(REPO_NAME)  --query "repositories[0].repositoryUri" --output text)
AWS_ACCOUNT_ID ?= $(shell aws sts get-caller-identity --query "Account" --output text)
AWS_REGION ?= $(shell aws configure get region)

# For build
PORT ?= 8080

# BUILD_ENVS
NEXT_PUBLIC_ENV ?= dev
NEXT_PUBLIC_LOG_LEVEL ?= info
NEXT_PUBLIC_FIREBASE_API_KEY ?= dummy
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN ?= dummy
NEXT_PUBLIC_FIREBASE_PROJECT_ID ?= dummy
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET ?= dummy
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID ?= dummy
NEXT_PUBLIC_FIREBASE_APP_ID ?= dummy
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID ?= dummy
NEXT_PUBLIC_SIGN_DOMAIN ?= dev.ratel.foundation
NEXT_PUBLIC_API_URL ?= http://localhost:3000
NEXT_PUBLIC_EXPERIMENT ?= false
NEXT_PUBLIC_TELEGRAM_BOTNAME ?= dummy

BUILD_ENV ?= VERSION=$(VERSION) \
							NEXT_PUBLIC_ENV=$(NEXT_PUBLIC_ENV) \
							NEXT_PUBLIC_LOG_LEVEL=$(NEXT_PUBLIC_LOG_LEVEL) \
							NEXT_PUBLIC_FIREBASE_API_KEY=$(NEXT_PUBLIC_FIREBASE_API_KEY) \
							NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=$(NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN) \
							NEXT_PUBLIC_FIREBASE_PROJECT_ID=$(NEXT_PUBLIC_FIREBASE_PROJECT_ID) \
							NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=$(NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET) \
							NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=$(NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID) \
							NEXT_PUBLIC_FIREBASE_APP_ID=$(NEXT_PUBLIC_FIREBASE_APP_ID) \
							NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=$(NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID) \
							NEXT_PUBLIC_SIGN_DOMAIN=$(NEXT_PUBLIC_SIGN_DOMAIN) \
							NEXT_PUBLIC_API_URL=$(NEXT_PUBLIC_API_URL) \
							NEXT_PUBLIC_EXPERIMENT=$(NEXT_PUBLIC_EXPERIMENT) \
							NEXT_PUBLIC_TELEGRAM_BOTNAME=$(NEXT_PUBLIC_TELEGRAM_BOTNAME)

DOCKER_FLAGS ?= --build-arg NEXT_PUBLIC_ENV=$(NEXT_PUBLIC_ENV) \
									--build-arg NEXT_PUBLIC_LOG_LEVEL=$(NEXT_PUBLIC_LOG_LEVEL) \
									--build-arg NEXT_PUBLIC_FIREBASE_API_KEY=$(NEXT_PUBLIC_FIREBASE_API_KEY) \
									--build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=$(NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN) \
									--build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID=$(NEXT_PUBLIC_FIREBASE_PROJECT_ID) \
									--build-arg NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=$(NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET) \
									--build-arg NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=$(NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID) \
									--build-arg NEXT_PUBLIC_FIREBASE_APP_ID=$(NEXT_PUBLIC_FIREBASE_APP_ID) \
									--build-arg NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=$(NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID) \
									--build-arg NEXT_PUBLIC_SIGN_DOMAIN=$(NEXT_PUBLIC_SIGN_DOMAIN) \
									--build-arg NEXT_PUBLIC_API_URL=$(NEXT_PUBLIC_API_URL) \
									--build-arg NEXT_PUBLIC_EXPERIMENT=$(NEXT_PUBLIC_EXPERIMENT) \
                  --build-arg NEXT_PUBLIC_VERSION=$(VERSION) \
									--build-arg NEXT_PUBLIC_TELEGRAM_BOTNAME=$(NEXT_PUBLIC_TELEGRAM_BOTNAME)


.PHONY: run node_module
node_module:
	pnpm i

run: node_module
	VERSION=$(VERSION) PORT=$(PORT) pnpm dev

build: node_module
	$(BUILD_ENV) pnpm build

docker.build:
	docker build -t $(ECR_NAME):$(COMMIT) --no-cache $(DOCKER_FLAGS) -f Dockerfile ../..

docker.push:
	docker push $(ECR_NAME):$(COMMIT)

docker.login:
	aws ecr get-login-password --region $(AWS_REGION) | docker login --username AWS --password-stdin $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com
