name: Playwright Tests

on:
  push:
    branches:
      - dev

jobs:
  playwright-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          ssh-key: ${{ secrets.PULL_KEY_REPO }}

      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Cache builder
        id: main-api-build-cache
        uses: actions/cache@v4
        with:
          key: main-api-build-${{ runner.os }}-rust-${{ env.RUSTC_HASH }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            main-api-build-${{ runner.os }}-rust-${{ env.RUSTC_HASH }}-
            main-api-build-${{ runner.os }}-
            main-api-build-
          path: |
            packages/main-api/target

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy, rustfmt
          target: wasm32-unknown-unknown
          toolchain: stable
      - uses: cargo-bins/cargo-binstall@main
      - name: Install toml-cli
        run: |
          cargo binstall toml-cli --force

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.15.0 --activate

      - name: Building APIs
        env:
          REGION: ap-northeast-2
          ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          ENV: dev
          RUST_LOG: info
          SERVICE: main-api
          DOMAIN: dev.ratel.foundation
          BUCKET_NAME: metadata.ratel.foundation
          SLACK_CHANNEL_SPONSOR: ${{ secrets.DEV_SLACK }}
          SLACK_CHANNEL_ABUSING: ${{ secrets.DEV_SLACK }}

          BINANCE_API_KEY: ${{ secrets.DEV_BINANCE_API_KEY }}
          BINANCE_SECRET_KEY: ${{ secrets.DEV_BINANCE_SECRET_KEY }}
          BINANCE_WEBHOOK: https://api.dev.ratel.foundation/v2/binances/webhooks
          REDIRECT_DOMAIN: https://dev.ratel.foundation

          KAIA_ENDPOINT: https://public-en-kairos.node.kaia.io
          KAIA_FEEPAYER_KEY: ${{ secrets.DEV_KAIA_KEY }}
          KAIA_FEEPAYER_ADDR: ${{ secrets.DEV_KAIA_ADDR }}
          KAIA_OWNER_KEY: ${{ secrets.DEV_KAIA_KEY }}
          KAIA_OWNER_ADDR: ${{ secrets.DEV_KAIA_ADDR }}

          TELEGRAM_TOKEN: ${{ secrets.DEV_TELEGRAM_TOKEN }}

          BBS_BLS_X: ${{ secrets.BBS_BLS_X }}
          BBS_BLS_Y: ${{ secrets.BBS_BLS_Y }}
          BBS_BLS_D: ${{ secrets.BBS_BLS_D }}
          BBS_BLS_CRV: ${{ secrets.BBS_BLS_CRV }}

          P256_X: ${{ secrets.P256_X }}
          P256_Y: ${{ secrets.P256_Y }}
          P256_D: ${{ secrets.P256_D }}
          P256_CRV: ${{ secrets.P256_CRV }}

          DYNAMO_TABLE_PREFIX: ratel-dev
          DYNAMO_ENDPOINT: none
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          RUST_FLAG: --features bypass
          WEB_BUILD: true
          PORTONE_API_SECRET: ${{ secrets.DEV_PORTONE_API_SECRET }}
          PORTONE_KPN_CHANNEL_KEY: ${{ secrets.DEV_PORTONE_KPN_CHANNEL_KEY }}
          PORTONE_STORE_ID: ${{ secrets.DEV_PORTONE_STORE_ID }}
        run: |
          make dist
          make docker.build

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Install dependencies
        run: pnpm i

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Setup test environment
        run: |
          docker-compose --profile testing up -d

      - name: Wait for services to be ready
        run: |
          # Check service health with retry loop and timeout
          echo "Waiting for services to be ready..."

          # Wait for Main API (180 second timeout for container startup)
          echo "ðŸ”„ Checking Main API..."
          timeout=180
          interval=10
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f -s http://localhost:3000/version > /dev/null 2>&1; then
              echo "âœ… Main API is responding (took ${elapsed}s)"
              break
            fi
            echo "â³ Main API not ready yet... (${elapsed}/${timeout}s)"
            sleep $interval
            elapsed=$((elapsed + interval))
          done

          if [ $elapsed -ge $timeout ]; then
            echo "âŒ Main API failed to respond with 200 status within ${timeout}s"
            echo "ðŸ” Checking Docker services status:"
            docker-compose -f docker-compose.yaml ps
            echo "ðŸ” Main API logs:"
            docker-compose -f docker-compose.yaml logs main-api-testing --tail=50
            exit 1
          fi

          echo "ðŸŽ‰ All services are ready!"

      - name: Run Playwright Tests
        env:
          CI: true
          RATEL_TEST_PLAYWRIGHT_URL: http://localhost:3000
        run: |
          cd ts-packages/web
          make test

      - name: Move Playwright test results
        if: ${{ !cancelled() }}
        run: |
          mv ts-packages/web/playwright-report ./

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  deploy-report:
    if: ${{ !cancelled() }}
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download test report artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
        continue-on-error: true

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: playwright-report/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment PR with test report link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const reportUrl = `${{ steps.deployment.outputs.page_url }}`;
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const comment = `## ðŸŽ­ Playwright Test Results

            **ðŸ“Š Test Report:** [View interactive test report](${reportUrl})

            **ðŸ“ Test Artifacts:**
            - Playwright report and screenshots are available in [GitHub Actions artifacts](${runUrl})

            **ðŸ“‹ Test Summary:**
            - Workflow: Playwright Tests  
            - Trigger: ${{ github.event_name }}
            - Commit: ${{ github.sha }}
            - Status: ${{ needs.test.result }}

            ---
            *Test report automatically deployed to GitHub Pages*`;

            // Find existing comment to update or create new one
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.find(comment => 
              comment.body.includes('ðŸŽ­ Playwright Test Results') && 
              comment.user.type === 'Bot'
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
